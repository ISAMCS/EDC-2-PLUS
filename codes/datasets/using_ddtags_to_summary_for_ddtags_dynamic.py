import torch
import json
from tqdm import tqdm
import os
import sys
import requests
from requests.auth import HTTPBasicAuth
import concurrent.futures
from codes.datasets.utils import llama4_maverick_request, Microsoft_Phi4_request, mistral7b_instruct_request, gpt35_turbo_0613_request
import re
import ast
from copy import deepcopy 

topkk = ast.literal_eval(sys.argv[1])
noises = ast.literal_eval(sys.argv[2])
length = sys.argv[3]
dataset = sys.argv[4]
eval_model = sys.argv[5]
date = sys.argv[6]
summary_prompt = sys.argv[7]
clustering_type = sys.argv[8]
benchmark = sys.argv[9]

if eval_model == "llama4_request":
    assess_model = llama4_maverick_request
elif eval_model == "Phi":
    assess_model = Microsoft_Phi4_request
elif eval_model == "mistral7b_instruct":
    assess_model = mistral7b_instruct_request
elif eval_model == "gpt35_turbo":
    assess_model = gpt35_turbo_0613_request
elif eval_model == "local_hf":
    assess_model = local_hf_request

filter_paragraph = ["No content to", "no content to", "I'm sorry", "I am sorry", "I can not provide", "I can't provide", "Could you clarify", "Sorry, I", "Could you clarify", "?"]

def replace_numbers_with_newline(text):
    # 使用正则表达式查找所有数字，并用换行符替换
    return re.sub(r'\d+.', '\n', text)

def _run_nli_GPT3(query, docs):
    global eval_model, summary_prompt
    #prompt = f"##Instruction##: You have been provided with a question and a collection of related documents. Your task is to extract the relevant information from these documents that can helping resolve this question. Focus on identifying key points, evidence, or details that are clearly connected to the question. Ensure the extracted content is concise, directly relevant, and maintains the context of the original documents. The extracted content must be objective, verifiable, and directly traceable to the original documents. Avoid making inferences or drawing conclusions based on the extracted content and DO NOT answer this question directly. If you find that the documents contain no relevant information, please output \"No content to extract\". Below are Three examples.\n\n##Question##:\nThe song \"Blinding Lights\" by The Weeknd was released as the 2nd single from which album and on what date?\n##Document##:\n1.\"Blinding Lights\" is a song by Canadian singer The Weeknd that was released as the second single from his fourth studio album, After Hours (2020). The song was first previewed in a Mercedes-Benz commercial on November 24, 2019, and later officially released on November 29, 2019. Produced by Max Martin and Oscar Holter, it became one of The Weeknd's biggest hits, topping the Billboard Hot 100 for four consecutive weeks and breaking numerous chart records globally. By the end of 2020, the song had amassed over 1.5 billion streams on Spotify and was named the most-streamed song of the year on the platform.\n2.The Weeknd performed \"Blinding Lights\" at several notable events, including the Super Bowl LV halftime show in February 2021. Critics have praised the song for its 80s-style synth-pop sound and emotional depth. After Hours, the album it was part of, was a commercial success, debuting at number one on the Billboard 200 and receiving widespread critical acclaim.\n##Response##:\nThe song \"Blinding Lights\" by The Weeknd was released as the second single from the album After Hours on November 29, 2019.\n\n##Question##:\nIn which year AD did Derrick Rose's three-point shooting percentage exceed 40%?\n##Document##:\n1.In his prime in Chicago, Rose was widely considered to be one of the most athletic point guards in NBA history before a string of knee injuries slowed him down. A combination of explosiveness, leaping ability and speed allowed him to attack the basket frequently, using a repertoire of acrobatic finishes to score over taller players. Rose clocked in a maximum vertical jump of 40 inches during the 2008 NBA Combine. After the injuries, Rose compensated for his loss of athleticism by becoming more patient, methodical and creative with his shot selection, which increased his efficiency compared to his early years when he considered himself to be more \"reckless\". His control, composure and finesse helped him keep his place among the best rim finishers in the NBA in the 2019–20 season, with his 4.7 field goals made on drives coming second behind only Luka Dončić and Russell Westbrook with 4.8, while he ranked first in the league in field goal percentage on attempts from drives among players with at least 6.0 attempts with 56.4%. In the process of reinventing his game, Rose also increased his reliance on floaters, runners and push shots, leading the league in the 2020–21 season in accuracy with 53% from the field on these attempts. Due to Rose's injury history, in his later years his minutes on the court were reduced and he became more of a role player.\n2.Rose has never been a knock-down shooter from the arc, shooting 30 percent for his career. However, in the later stages of his career, he improved his shooting mechanics and managed to develop a reliable three point shot. In his second stint with the New York Knicks, Rose shot above 40 percent from three. Rose started using the bank shot more frequently and with greater success during the 2015–16 season, after struggling with his shooting due to what he attributes to depth perception issues following eye surgery in 2015.\n##Response##:\nIn his second stint with the New York Knicks, Rose shot above 40 percent from three.\n\n\##Question##:\nWhat role did Shaquille O'Neal play in Uncle Drew?\n##Documents##:\n1.Uncle Drew is a 2018 American sports comedy film directed by Charles Stone III and written by Jay Longino. It stars Kyrie Irving as the title character from his Pepsi Max advertisements that began airing in 2012, along with former NBA players Shaquille O'Neal, Chris Webber, Reggie Miller, and Nate Robinson, as well as former WNBA player Lisa Leslie. Lil Rel Howery, Erica Ash, J. B. Smoove, Mike Epps, Tiffany Haddish, Nick Kroll, and Aaron Gordon also star.2.The film was released in the United States by Lionsgate on June 29, 2018, and received mixed reviews from critics, who praised the performances of the cast, but called the direction and screenplay \"formulaic\".\n##Response##:\nNo content to extract\n\n##Question##:\n{question}\n##Documents##:\n{docs}\n##Response##:"
    #prompt 1031
    #prompt 1110
    #prompt = f"##Question##:\nIn which year AD did Derrick Rose's three-point shooting percentage exceed 40%?\n##Document##:\n1.In his prime in Chicago, Rose was widely considered to be one of the most athletic point guards in NBA history before a string of knee injuries slowed him down. A combination of explosiveness, leaping ability and speed allowed him to attack the basket frequently, using a repertoire of acrobatic finishes to score over taller players. Rose clocked in a maximum vertical jump of 40 inches during the 2008 NBA Combine. After the injuries, Rose compensated for his loss of athleticism by becoming more patient, methodical and creative with his shot selection, which increased his efficiency compared to his early years when he considered himself to be more \"reckless\". His control, composure and finesse helped him keep his place among the best rim finishers in the NBA in the 2019–20 season, with his 4.7 field goals made on drives coming second behind only Luka Dončić and Russell Westbrook with 4.8, while he ranked first in the league in field goal percentage on attempts from drives among players with at least 6.0 attempts with 56.4%. In the process of reinventing his game, Rose also increased his reliance on floaters, runners and push shots, leading the league in the 2020–21 season in accuracy with 53% from the field on these attempts. Due to Rose's injury history, in his later years his minutes on the court were reduced and he became more of a role player.\n2.Rose has never been a knock-down shooter from the arc, shooting 30 percent for his career. However, in the later stages of his career, he improved his shooting mechanics and managed to develop a reliable three point shot. In his second stint with the New York Knicks, Rose shot above 40 percent from three. Rose started using the bank shot more frequently and with greater success during the 2015–16 season, after struggling with his shooting due to what he attributes to depth perception issues following eye surgery in 2015.\n3.Rose has struggled with significant knee injuries since his 2010–11 MVP season. In the first round of the 2012 NBA playoffs against the Philadelphia 76ers, Rose tore his ACL in his left knee. He required surgery and was subsequently sidelined for the entire 2012–13 season. Rose returned to play in 2013–14, but in November 2013, he injured his right meniscus, causing him to miss the remainder of the season. He returned once again the following season, but knee injuries continued to impact his availability and production. In June 2016, Rose was traded to the New York Knicks, where he finished the final year of his contract. He signed with the Cleveland Cavaliers on a minimum salary for the 2017–18 season but was hobbled by ankle injuries, which led to him being traded to and subsequently waived by the Utah Jazz in February 2018.\n##Summarized Docs##:\nIn his second stint with the New York Knicks, Rose shot above 40 percent from three.\nIn June 2016, Rose was traded to the New York Knicks, where he finished the final year of his contract.\n\n##Question##:\nWhat annual event at the gravesite of a notable American inventor, known for his work with electricity, attracts a mysterious visitor who leaves a specific item as a tribute?\n##Document##:\n1.Every October 18, the anniversary of Thomas Edison’s birthday, an unidentified visitor arrives at Edison’s gravesite in West Orange, New Jersey. Known as the \"Edison Visitor,\" this individual leaves a single lightbulb with a small note. The tribute, which has continued for decades, is thought to symbolize Edison’s pioneering work in electricity and invention.\n2.The visitor, dressed in a dark suit and gloves, is often seen in the early hours at Edison’s burial site. He places the lightbulb carefully on the ground near Edison’s gravestone, then stands silently for a few minutes before departing. The note usually carries a short message, such as \"To a bright mind\" or \"The light you shared still shines.\"\n3.The first sighting of the mysterious tribute occurred in the 1950s, though no one has confirmed the exact year. Some believe it was initiated by a local historian who admired Edison’s legacy. Others speculate it was a close family member or friend who chose anonymity to emphasize Edison’s work over personal fame.\n4.Edison’s most famous invention, the lightbulb, symbolizes the innovation and perseverance he demonstrated throughout his life. The placement of the lightbulb each year serves as a reminder of Edison’s contribution to modern technology and continues to inspire those who visit his gravesite.\n5.In 1998, a man claimed responsibility for the tradition, stating it was part of a local effort to preserve Edison’s memory. However, his account was unverified, and the true identity of the visitor remains unknown. The Edison Visitor’s last confirmed appearance was in 2015, though similar tributes occasionally appear.\n##Summarized Docs##:\nEach year on October 18, a mysterious visitor known as the \"Edison Visitor\" pays tribute to American inventor Thomas Edison at his gravesite in West Orange, New Jersey. The visitor, dressed in dark clothing, places a lightbulb near Edison’s gravestone, symbolizing his contributions to modern technology. This tradition, believed to have started in the 1950s, remains shrouded in mystery, with no definitive origin or verified identity of the tribute’s creator.\n\n##Instruction##: You have been provided with a question and a collection of related documents. Your task is to extract the relevant information from these documents that can helping resolve this question. Focus on identifying key points, evidence, or details that are clearly connected to the question. Ensure the extracted content is concise, directly relevant, and maintains the context of the original documents. ##The extracted content must be objective, verifiable, and directly traceable to the original documents. Avoid making inferences or drawing conclusions based on the extracted content and DO NOT answer this question directly.## If you find that the documents contain no relevant information, please output \"No content to extract\".\n\n##Question##:\n{question}\n##Documents##:\n{docs}\n##Summarized Docs##:\n"
    #prompt 1121
    if summary_prompt == "1121":
        prompt = f"##Instruction##:\nIdentify instances in Derrick Rose's career where his three-point shooting percentage was notably high, based on the provided documents.\n##Document##:\n1.In his prime in Chicago, Rose was widely considered to be one of the most athletic point guards in NBA history before a string of knee injuries slowed him down. A combination of explosiveness, leaping ability and speed allowed him to attack the basket frequently, using a repertoire of acrobatic finishes to score over taller players. Rose clocked in a maximum vertical jump of 40 inches during the 2008 NBA Combine. After the injuries, Rose compensated for his loss of athleticism by becoming more patient, methodical and creative with his shot selection, which increased his efficiency compared to his early years when he considered himself to be more \"reckless\". His control, composure and finesse helped him keep his place among the best rim finishers in the NBA in the 2019–20 season, with his 4.7 field goals made on drives coming second behind only Luka Dončić and Russell Westbrook with 4.8, while he ranked first in the league in field goal percentage on attempts from drives among players with at least 6.0 attempts with 56.4%. In the process of reinventing his game, Rose also increased his reliance on floaters, runners and push shots, leading the league in the 2020–21 season in accuracy with 53% from the field on these attempts. Due to Rose's injury history, in his later years his minutes on the court were reduced and he became more of a role player.\n2.Rose has never been a knock-down shooter from the arc, shooting 30 percent for his career. However, in the later stages of his career, he improved his shooting mechanics and managed to develop a reliable three point shot. In his second stint with the New York Knicks, Rose shot above 40 percent from three. Rose started using the bank shot more frequently and with greater success during the 2015–16 season, after struggling with his shooting due to what he attributes to depth perception issues following eye surgery in 2015.\n3.Rose has struggled with significant knee injuries since his 2010–11 MVP season. In the first round of the 2012 NBA playoffs against the Philadelphia 76ers, Rose tore his ACL in his left knee. He required surgery and was subsequently sidelined for the entire 2012–13 season. Rose returned to play in 2013–14, but in November 2013, he injured his right meniscus, causing him to miss the remainder of the season. He returned once again the following season, but knee injuries continued to impact his availability and production. In June 2016, Rose was traded to the New York Knicks, where he finished the final year of his contract. He signed with the Cleveland Cavaliers on a minimum salary for the 2017–18 season but was hobbled by ankle injuries, which led to him being traded to and subsequently waived by the Utah Jazz in February 2018.\n##Extracted Content##:\nDerrick Rose's three-point shooting percentage was notably high during his second stint with the New York Knicks. In that period, he shot above 40 percent from three, showcasing a significant improvement compared to his career average of 30 percent.\n\n##Instruction##:\nGather information about annual events or traditions involving tributes left at the gravesites of notable American inventors, particularly those known for contributions to electricity.\n##Documents##:\n1.Every October 18, the anniversary of Thomas Edison’s birthday, an unidentified visitor arrives at Edison’s gravesite in West Orange, New Jersey. Known as the \"Edison Visitor,\" this individual leaves a single lightbulb with a small note. The tribute, which has continued for decades, is thought to symbolize Edison’s pioneering work in electricity and invention.\n2.The visitor, dressed in a dark suit and gloves, is often seen in the early hours at Edison’s burial site. He places the lightbulb carefully on the ground near Edison’s gravestone, then stands silently for a few minutes before departing. The note usually carries a short message, such as \"To a bright mind\" or \"The light you shared still shines.\"\n3.The first sighting of the mysterious tribute occurred in the 1950s, though no one has confirmed the exact year. Some believe it was initiated by a local historian who admired Edison’s legacy. Others speculate it was a close family member or friend who chose anonymity to emphasize Edison’s work over personal fame.\n4.Edison’s most famous invention, the lightbulb, symbolizes the innovation and perseverance he demonstrated throughout his life. The placement of the lightbulb each year serves as a reminder of Edison’s contribution to modern technology and continues to inspire those who visit his gravesite.\n5.In 1998, a man claimed responsibility for the tradition, stating it was part of a local effort to preserve Edison’s memory. However, his account was unverified, and the true identity of the visitor remains unknown. The Edison Visitor’s last confirmed appearance was in 2015, though similar tributes occasionally appear.\nn##Extracted Content##:\nAn annual tradition tied to tributes left at the gravesites of notable American inventors includes the mysterious ritual honoring Thomas Edison. Every October 18, on Edison’s birthday, an unidentified individual known as the \"Edison Visitor\" leaves a single lightbulb at Edison’s gravesite in West Orange, New Jersey. The lightbulb symbolizes Edison’s pioneering contributions to electricity and innovation.\nKey details of this tradition:\nThe visitor, dressed in a dark suit and gloves, carefully places the lightbulb near Edison’s gravestone and includes a note with messages like, \"To a bright mind\" or \"The light you shared still shines.\" They then stand silently for a few minutes before departing.\nThis tribute began in the 1950s, although its exact origins are uncertain. Theories suggest it might have started with a local historian, a close associate of Edison, or someone wishing to highlight Edison’s legacy.\nWhile the identity of the visitor remains unknown, a claim in 1998 suggested it was part of a local effort to preserve Edison’s memory, though this was unverified.\nThe last confirmed appearance of the Edison Visitor was in 2015, but similar tributes have occasionally been reported since.\nThis annual act underscores the enduring reverence for Edison’s role in shaping modern technology.\n\n##Instruction##: \n{query}\n##Requirment##:\nYour task is to extract relevant information from these documents based on the provided instruction. Focus on identifying key points, evidence, or details that are clearly related to the described topic or task in the input statement. Ensure the extracted content is concise, directly relevant, and maintains the context of the original documents. The extracted content must be objective, verifiable, and directly traceable to the original documents. Avoid making inferences or drawing conclusions beyond the information explicitly stated in the documents.If you find that the documents contain no relevant information, please output: \"No content to extract.\"\n##Documents##:\n{docs}\n##Extracted Content##:\n"
    elif summary_prompt == "1110":
        prompt = f"##Question##:\nIn which year AD did Derrick Rose's three-point shooting percentage exceed 40%?\n##Document##:\n1.In his prime in Chicago, Rose was widely considered to be one of the most athletic point guards in NBA history before a string of knee injuries slowed him down. A combination of explosiveness, leaping ability and speed allowed him to attack the basket frequently, using a repertoire of acrobatic finishes to score over taller players. Rose clocked in a maximum vertical jump of 40 inches during the 2008 NBA Combine. After the injuries, Rose compensated for his loss of athleticism by becoming more patient, methodical and creative with his shot selection, which increased his efficiency compared to his early years when he considered himself to be more \"reckless\". His control, composure and finesse helped him keep his place among the best rim finishers in the NBA in the 2019–20 season, with his 4.7 field goals made on drives coming second behind only Luka Dončić and Russell Westbrook with 4.8, while he ranked first in the league in field goal percentage on attempts from drives among players with at least 6.0 attempts with 56.4%. In the process of reinventing his game, Rose also increased his reliance on floaters, runners and push shots, leading the league in the 2020–21 season in accuracy with 53% from the field on these attempts. Due to Rose's injury history, in his later years his minutes on the court were reduced and he became more of a role player.\n2.Rose has never been a knock-down shooter from the arc, shooting 30 percent for his career. However, in the later stages of his career, he improved his shooting mechanics and managed to develop a reliable three point shot. In his second stint with the New York Knicks, Rose shot above 40 percent from three. Rose started using the bank shot more frequently and with greater success during the 2015–16 season, after struggling with his shooting due to what he attributes to depth perception issues following eye surgery in 2015.\n3.Rose has struggled with significant knee injuries since his 2010–11 MVP season. In the first round of the 2012 NBA playoffs against the Philadelphia 76ers, Rose tore his ACL in his left knee. He required surgery and was subsequently sidelined for the entire 2012–13 season. Rose returned to play in 2013–14, but in November 2013, he injured his right meniscus, causing him to miss the remainder of the season. He returned once again the following season, but knee injuries continued to impact his availability and production. In June 2016, Rose was traded to the New York Knicks, where he finished the final year of his contract. He signed with the Cleveland Cavaliers on a minimum salary for the 2017–18 season but was hobbled by ankle injuries, which led to him being traded to and subsequently waived by the Utah Jazz in February 2018.\n##Summarized Docs##:\nIn his second stint with the New York Knicks, Rose shot above 40 percent from three.\nIn June 2016, Rose was traded to the New York Knicks, where he finished the final year of his contract.\n\n##Question##:\nWhat annual event at the gravesite of a notable American inventor, known for his work with electricity, attracts a mysterious visitor who leaves a specific item as a tribute?\n##Document##:\n1.Every October 18, the anniversary of Thomas Edison’s birthday, an unidentified visitor arrives at Edison’s gravesite in West Orange, New Jersey. Known as the \"Edison Visitor,\" this individual leaves a single lightbulb with a small note. The tribute, which has continued for decades, is thought to symbolize Edison’s pioneering work in electricity and invention.\n2.The visitor, dressed in a dark suit and gloves, is often seen in the early hours at Edison’s burial site. He places the lightbulb carefully on the ground near Edison’s gravestone, then stands silently for a few minutes before departing. The note usually carries a short message, such as \"To a bright mind\" or \"The light you shared still shines.\"\n3.The first sighting of the mysterious tribute occurred in the 1950s, though no one has confirmed the exact year. Some believe it was initiated by a local historian who admired Edison’s legacy. Others speculate it was a close family member or friend who chose anonymity to emphasize Edison’s work over personal fame.\n4.Edison’s most famous invention, the lightbulb, symbolizes the innovation and perseverance he demonstrated throughout his life. The placement of the lightbulb each year serves as a reminder of Edison’s contribution to modern technology and continues to inspire those who visit his gravesite.\n5.In 1998, a man claimed responsibility for the tradition, stating it was part of a local effort to preserve Edison’s memory. However, his account was unverified, and the true identity of the visitor remains unknown. The Edison Visitor’s last confirmed appearance was in 2015, though similar tributes occasionally appear.\n##Summarized Docs##:\nEach year on October 18, a mysterious visitor known as the \"Edison Visitor\" pays tribute to American inventor Thomas Edison at his gravesite in West Orange, New Jersey. The visitor, dressed in dark clothing, places a lightbulb near Edison’s gravestone, symbolizing his contributions to modern technology. This tradition, believed to have started in the 1950s, remains shrouded in mystery, with no definitive origin or verified identity of the tribute’s creator.\n\n##Instruction##: You have been provided with a question and a collection of related documents. Your task is to extract the relevant information from these documents that can helping resolve this question. Focus on identifying key points, evidence, or details that are clearly connected to the question. Ensure the extracted content is concise, directly relevant, and maintains the context of the original documents. ##The extracted content must be objective, verifiable, and directly traceable to the original documents. Avoid making inferences or drawing conclusions based on the extracted content and DO NOT answer this question directly.## If you find that the documents contain no relevant information, please output \"No content to extract\".\n\n##Question##:\n{query}\n##Documents##:\n{docs}\n##Summarized Docs##:\n"
    res = 0
    while (True):
        try:
            text = assess_model(prompt)
            if eval_model == "llama3_request" or eval_model == "qwen_request":
                text = text.split("##Extracted Content##:")[-1].strip()
            return text
        except Exception as e:
            print(f"An error occurred: {e}")

def process_slice(slice_cases):
    global topk, summary_prompt, dataset
    outs = []
    for case_1 in tqdm(slice_cases):
        case = deepcopy(case_1)
        res=0
        topk = int(topk)
        if dataset == "redundancy":
            docs = case["docs"]
        else:
            docs = [case['passages'][i]['text'] for i in range(topk)]
        tagss = [case["tags"][str(i)][0:topk-1-i] for i in range(topk)]
        for passage in case['passages']:
            if 'embedding' in passage:
                del passage['embedding']
        Tags = {i:0 for i in range(topk)}
        docs_final = []
        if topk == 1:
            docs_final = [f"1.{docs[0]}"]
        for i, tags in enumerate(tagss):
            if Tags[i] == 0:
                doc = []
                doc.append(docs[i])
                for j, tag in enumerate(tags):
                    if tag == 1:
                        Tags[i+j+1] = 1
                        doc.append(docs[i+j+1])
                docs_final.append("\n".join([f"{k+1}.{doc[k]}" for k in range(len(doc))]))
        case["docs_final"] = docs_final
        case["summary_docs"] = []
        if docs_final:
            for doc in docs_final:
                if summary_prompt == "1110":
                    query = case["question"]
                elif summary_prompt == "1121":
                    query = case["rewritten_query"]
                res = _run_nli_GPT3(query, doc)
                tag = 0
                for paragraph in filter_paragraph:
                    if paragraph in res:
                        tag = 1
                        break
                if tag == 0:
                    case["summary_docs"].append(res)
        outs.append(case)
    return outs

def run(topk, noise):
    global eval_model, date, dataset, length, summary_prompt
    eval_method = {
        "llama4_request": "llama4",
        "Phi_request": "Phi",
        "ChatGPT_request": "3.5turbo",
        "mistral7b_instruct_request": "mistral7b",
        "gpt35_turbo_0613_request": "3.5turbo"
    }.get(eval_model, eval_model)
    res_file = f"{benchmark}/datasets/case_{date}_summary_{eval_method}_{summary_prompt}_{dataset}_results_ddtags_{clustering_type}_{length}_noise{noise}_topk{topk}.json"
    case_file = f"{benchmark}/datasets/case_{dataset}_{benchmark}_ddtags_noise{noise}_topk{topk}_{clustering_type}_{length}_embedding.json"
    with open(case_file, "r", encoding="utf-8") as lines:
        cases = json.load(lines)
        # Sequentially process all cases
        final_result = process_slice(cases)
        with open(res_file, "w", encoding="utf-8") as json_file:
            json.dump(final_result, json_file, ensure_ascii=False, indent=4)

for topk in topkk:
    for noise in noises:
        run(topk, noise)
        print(f"Finished running for topk={topk} and noise={noise} and length={length} and summary_prompt={summary_prompt} In Summarize Docs") 